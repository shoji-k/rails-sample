<p id="error"></p>

<%= form_for(editor, remote: true) do |f| %>

  <label class="checkbox-inline">
    <%= check_box_tag "editor[input_mode]", 1, true,
      data: { toggle: "toggle", on: "LaTex code", off: "view", onstyle: "primary", offstyle: "danger" },
      class: "toggle"
     %>
  </label>

  <% if editor.errors.any? %>
    <div id="error_explanation">
      <h2><%= pluralize(editor.errors.count, "error") %> prohibited this editor from being saved:</h2>

      <ul>
      <% editor.errors.full_messages.each do |message| %>
        <li><%= message %></li>
      <% end %>
      </ul>
    </div>
  <% end %>

  <div class="field">
    <%= f.label :title %>
    <%= f.text_field :title %>
  </div>

  <div class="field">
    <%= f.label :body %>
    <%= f.cktext_area :body %>
  </div>

  <div class="field">
    <%= f.label :tex %>
    <%= f.text_area :tex, id: 'tex_editor' %>
  </div>

  <div class="actions update-box">
    <%= f.submit 'Update Editor', id: 'update' %>
  </div>
<% end %>

<!-- <button id="update">update by ajax</button> -->
<button id="tex-to-html">tex to html</button>
<button id="html-to-tex">html to tex</button>

<script>
$(function() {
  $('#toggle-body').change(function() {
    var latex_mode = $(this).prop('checked');
    if (latex_mode) {
      console.log('latex mode');
    } else {
      console.log('html mode');
    }
  });

  var AUTOSAVEINTERVAL = 2000;
  var editor = window.CKEDITOR.instances['editor_body'];

  <% if !@ajaxUrl.nil? %>
  var change_flg = 0;
  editor.on('change', function() {
    change_flg = 1;
  });
  // autosave
  setInterval(function() {
    if (change_flg == 1) {
      console.log(1);
      change_flg = 0;
      update();
    }
  }, AUTOSAVEINTERVAL);

  function update() {
    var that = this;
    var title = $('#editor_title').val();
    var body = editor.getData();

    $('#error').text('');
    if (! title) {
      $('#error').text('タイトルを入力してください');
      return false;
    }

    $(this).prop('disabled', true)
      .after('<div id="spin" class="spinner"></div>')
      .submit();
  };

  $('#update').on('click', update);
  <% end %>

  $(document).on('turbolinks:load', function() {
    $('input[type="checkbox"].toggle').bootstrapToggle();
  });

 var tex_editor = CodeMirror.fromTextArea(document.getElementById('tex_editor'), {
    mode: "text/x-stex",
    lineNumbers: true,
    indentUnit: 4,
    dragDrop: true,
    viewportMargin: 100,
  });
});
(function($){
  'use strict';
  $.fn.ready = function(func){
    $(document).on('turbolinks:load', function () {
      func($);
    });
  };
})(jQuery);
</script>
